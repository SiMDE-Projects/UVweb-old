<?php

namespace Uvweb\UvBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * CommentRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CommentRepository extends EntityRepository
{
	public function averageRate(Uv $uv)
	{
		$qb = $this->createQueryBuilder('c');

		$qb->select('AVG(c.globalRate) as globalRate')
		   ->where('c.moderated = :moderated')->setParameter('moderated', true)
		   ->andWhere('c.uv = :uv')->setParameter('uv', $uv);

		return $qb->getQuery()->getSingleScalarResult();
	}

    private function averageCriteria(Uv $uv, $criteria)
    {
        $qb = $this->createQueryBuilder('c');
        $qb
            ->select('COUNT(c) as value')
            ->addSelect("c.$criteria as label")
            ->where('c.moderated = :moderated')->setParameter('moderated', true)
            ->groupBy("c.$criteria")
            ->andWhere('c.uv = :uv')->setParameter('uv', $uv);

        return $qb->getQuery()->getScalarResult();
	}

    public function averageCriterias(Uv $uv)
    {
        return [
            'pedagody' => $this->averageCriteria($uv, 'pedagogy'),
            'utility'  => $this->averageCriteria($uv, 'utility'),
            'interest'  => $this->averageCriteria($uv, 'interest'),
            'workAmount'  => $this->averageCriteria($uv, 'workAmount'),
        ];
	}

	public function userAlreadyCommentedUv(User $user, Uv $uv)
	{
		$qb = $this->createQueryBuilder('c');

		$qb->where('c.author = :author')->setParameter('author', $user->getId())
		   ->andWhere('c.uv = :uv')->setParameter('uv', $uv->getId());

		$comment = $qb->getQuery()->getOneOrNullResult();

		return $comment !== null;
	}

	private function prepareUvListQuery($limit = 0, $category = '', $webService)
	{
		$qb = $this->createQueryBuilder('c');

		$qb->select('AVG(c.globalRate) AS globalRate')
            ->addSelect('COUNT(c.globalRate) AS commentCount')
            ->addSelect('u.name as name')
            ->join('c.uv', 'u')
		    ->where('c.moderated = :moderated')->setParameter('moderated', true)
		    ->andWhere('u.archived = :archived')->setParameter('archived', 0)
		    ->groupBy('name');

		//Called for web service
		if($webService)
		{
			$qb->addSelect('u.title as title');
		}

		if(!empty($category) && $category !== 'all')
		{
			if($category !== 'tsh')
			{
				$qb->join('u.categories', 'cat')
				   ->andWhere('cat.category = :categorie')->setParameter('categorie', $category);
			}
			else
			{
				//TSH
				$qb->join('u.categories', 'cat')
				   ->andWhere('cat.category in (:tsh)')->setParameter('tsh', array('EC', 'ME', 'CT'));
			}
		}

        if($limit > 0)
        	$qb->setMaxResults($limit);

		return $qb;
	}

	public function uvsOrderedByRate($limit = 0, $best = true, $minCountComments = 0, $category = '', $webService = false)
	{
		$qb = $this->prepareUvListQuery($limit, $category, $webService);

		if($minCountComments > 0)
		    $qb->having('commentCount > :minCount')->setParameter('minCount', $minCountComments);

		//Order by rate first
		if($best)
            $qb->orderBy('globalRate', 'DESC');
        else
            $qb->orderBy('globalRate', 'ASC');

        //Then by name
        $qb->addOrderBy('name');

        //If web service call: return an array, as it will be encoded as Json
        if($webService)
        	return $qb->getQuery()->getScalarResult();

        //Else return array of objects
		return $qb->getQuery()->getResult();
	}

	public function uvsOrderedByName($limit = 0, $category = '', $webService = false)
	{
		$qb = $this->prepareUvListQuery($limit, $category, $webService);

        $qb->addOrderBy('name');

        //If web service call: return an array, as it will be encoded as Json
        if($webService)
        	return $qb->getQuery()->getScalarResult();

        //Else return array of objects
		return $qb->getQuery()->getResult();
	}
}
